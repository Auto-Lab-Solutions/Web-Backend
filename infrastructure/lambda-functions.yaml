AWSTemplateFormatVersion: '2010-09-09'
Description: 'Lambda Functions for Auto Lab Solutions'

Parameters:
  Environment:
    Type: String
    Default: production
    Description: Environment name
  
  CloudFormationBucket:
    Type: String
    Description: S3 bucket containing Lambda packages
  
  StaffTable:
    Type: String
    Description: Staff Table Name
  
  UsersTable:
    Type: String
    Description: Users Table Name
  
  ConnectionsTable:
    Type: String
    Description: Connections Table Name
  
  MessagesTable:
    Type: String
    Description: Messages Table Name
  
  UnavailableSlotsTable:
    Type: String
    Description: UnavailableSlots Table Name
  
  AppointmentsTable:
    Type: String
    Description: Appointments Table Name
  
  ServicePricesTable:
    Type: String
    Description: ServicePrices Table Name
  
  OrdersTable:
    Type: String
    Description: Orders Table Name
  
  ItemPricesTable:
    Type: String
    Description: ItemPrices Table Name
  
  InquiriesTable:
    Type: String
    Description: Inquiries Table Name

  PaymentsTable:
    Type: String
    Description: Payments Table Name
  
  StripeSecretKey:
    Type: String
    NoEcho: true
    Description: Stripe secret key for payment processing
  
  StripeWebhookSecret:
    Type: String
    NoEcho: true
    Description: Stripe webhook endpoint secret for signature verification

  Auth0Domain:
    Type: String
    NoEcho: true
    Description: Auth0 domain for token validation
    Default: ""

  Auth0Audience:
    Type: String
    NoEcho: true
    Description: Auth0 API audience for token validation
    Default: ""

  CloudFrontDomain:
    Type: String
    Description: CloudFront domain for file access
    Default: ""

  ReportsBucketName:
    Type: String
    Description: S3 bucket name for storing reports
    Default: ""

  SharedKey:
    Type: String
    NoEcho: true
    Description: Shared key for secure operations
    Default: ""

  Stage:
    Type: String
    Description: API Gateway stage name
    Default: "prod"

  InvoiceGenerationQueueUrl:
    Type: String
    Description: SQS Queue URL for invoice generation
    Default: ""

  MailSendingAddress:
    Type: String
    Description: SES verified email address for sending emails
    Default: "noreply@autolabsolutions.com"

  SesRegion:
    Type: String
    Description: AWS SES region
    Default: "us-east-1"

  FrontendRootUrl:
    Type: String
    Description: Frontend root URL for invoice links and QR codes
    Default: ""

  InvoicesTable:
    Type: String
    Description: Invoices Table Name

  InvoiceQueueUrl:
    Type: String
    Description: SQS Queue URL for asynchronous invoice processing
    Default: ""

  EmailStorageBucket:
    Type: String
    Description: S3 bucket for storing received emails
    Default: ""

  EmailMetadataTable:
    Type: String
    Description: DynamoDB table for email metadata
    Default: ""

  MailReceivingAddress:
    Type: String
    Description: Email address for receiving emails (environment-specific)
    Default: "mail@autolabsolutions.com"

Conditions:
  IsProduction: !Equals [!Ref Environment, 'production']

Resources:
  # Lambda Execution Role
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub 'auto-lab-lambda-execution-role-${Environment}'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:DeleteItem
                  - dynamodb:Query
                  - dynamodb:Scan
                Resource:
                  - !Sub 'arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${StaffTable}'
                  - !Sub 'arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${StaffTable}/index/*'
                  - !Sub 'arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${UsersTable}'
                  - !Sub 'arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${UsersTable}/index/*'
                  - !Sub 'arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ConnectionsTable}'
                  - !Sub 'arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ConnectionsTable}/index/*'
                  - !Sub 'arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${MessagesTable}'
                  - !Sub 'arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${MessagesTable}/index/*'
                  - !Sub 'arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${UnavailableSlotsTable}'
                  - !Sub 'arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${UnavailableSlotsTable}/index/*'
                  - !Sub 'arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${AppointmentsTable}'
                  - !Sub 'arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${AppointmentsTable}/index/*'
                  - !Sub 'arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ServicePricesTable}'
                  - !Sub 'arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ServicePricesTable}/index/*'
                  - !Sub 'arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${OrdersTable}'
                  - !Sub 'arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${OrdersTable}/index/*'
                  - !Sub 'arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ItemPricesTable}'
                  - !Sub 'arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ItemPricesTable}/index/*'
                  - !Sub 'arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${InquiriesTable}'
                  - !Sub 'arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${InquiriesTable}/index/*'
                  - !Sub 'arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${PaymentsTable}'
                  - !Sub 'arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${PaymentsTable}/index/*'
                  - !Sub 'arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${InvoicesTable}'
                  - !Sub 'arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${InvoicesTable}/index/*'
        - PolicyName: S3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                  - s3:GetObjectUrl
                Resource: '*'
        - PolicyName: ApiGatewayAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - execute-api:ManageConnections
                Resource: '*'
        - PolicyName: SQSAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - sqs:SendMessage
                  - sqs:GetQueueAttributes
                Resource: '*'
        - PolicyName: SESAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - ses:SendEmail
                  - ses:SendRawEmail
                  - ses:GetSendQuota
                  - ses:GetSendStatistics
                Resource: '*'
        - PolicyName: S3EmailStorageAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                Resource: !Sub 'arn:aws:s3:::${EmailStorageBucket}/*'
              - Effect: Allow
                Action:
                  - s3:ListBucket
                Resource: !Sub 'arn:aws:s3:::${EmailStorageBucket}'

  # Staff Authorizer Lambda
  StaffAuthorizer:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'staff-authorizer-${Environment}'
      Runtime: python3.13
      Handler: main.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Code:
        S3Bucket: !Ref CloudFormationBucket
        S3Key: lambda/staff-authorizer.zip
      Environment:
        Variables:
          ENVIRONMENT: !Ref Environment
          LOG_LEVEL: !If [IsProduction, 'INFO', 'DEBUG']
          AUTH0_DOMAIN: !Ref Auth0Domain
          AUTH0_AUDIENCE: !Ref Auth0Audience
      Timeout: !If [IsProduction, 60, 30]
      MemorySize: !If [IsProduction, 512, 256]
      Tags:
        - Key: Environment
          Value: !Ref Environment

  # Staff Authorizer Optional Lambda
  StaffAuthorizerOptional:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'staff-authorizer-optional-${Environment}'
      Runtime: python3.13
      Handler: main.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Code:
        S3Bucket: !Ref CloudFormationBucket
        S3Key: lambda/staff-authorizer-optional.zip
      Environment:
        Variables:
          ENVIRONMENT: !Ref Environment
          AUTH0_DOMAIN: !Ref Auth0Domain
          AUTH0_AUDIENCE: !Ref Auth0Audience
      Tags:
        - Key: Environment
          Value: !Ref Environment

  # API Lambda Functions
  ApiGetPrices:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'api-get-prices-${Environment}'
      Runtime: python3.13
      Handler: main.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Code:
        S3Bucket: !Ref CloudFormationBucket
        S3Key: lambda/api-get-prices.zip
      Environment:
        Variables:
          STAFF_TABLE: !Ref StaffTable
          ITEM_PRICES_TABLE: !Ref ItemPricesTable
          SERVICE_PRICES_TABLE: !Ref ServicePricesTable
          ENVIRONMENT: !Ref Environment
      Tags:
        - Key: Environment
          Value: !Ref Environment

  ApiGetUsers:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'api-get-users-${Environment}'
      Runtime: python3.13
      Handler: main.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Code:
        S3Bucket: !Ref CloudFormationBucket
        S3Key: lambda/api-get-users.zip
      Environment:
        Variables:
          STAFF_TABLE: !Ref StaffTable
          USERS_TABLE: !Ref UsersTable
          ENVIRONMENT: !Ref Environment
      Tags:
        - Key: Environment
          Value: !Ref Environment

  ApiGetAppointments:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'api-get-appointments-${Environment}'
      Runtime: python3.13
      Handler: main.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Code:
        S3Bucket: !Ref CloudFormationBucket
        S3Key: lambda/api-get-appointments.zip
      Environment:
        Variables:
          STAFF_TABLE: !Ref StaffTable
          USERS_TABLE: !Ref UsersTable
          APPOINTMENTS_TABLE: !Ref AppointmentsTable
          ENVIRONMENT: !Ref Environment
      Tags:
        - Key: Environment
          Value: !Ref Environment

  ApiCreateAppointment:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'api-create-appointment-${Environment}'
      Runtime: python3.13
      Handler: main.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Code:
        S3Bucket: !Ref CloudFormationBucket
        S3Key: lambda/api-create-appointment.zip
      Environment:
        Variables:
          STAFF_TABLE: !Ref StaffTable
          APPOINTMENTS_TABLE: !Ref AppointmentsTable
          USERS_TABLE: !Ref UsersTable
          CONNECTIONS_TABLE: !Ref ConnectionsTable
          SERVICE_PRICES_TABLE: !Ref ServicePricesTable
          ENVIRONMENT: !Ref Environment
          MAIL_FROM_ADDRESS: !Ref MailReceivingAddress
          FRONTEND_ROOT_URL: !Ref FrontendRootUrl
          EMAIL_NOTIFICATION_QUEUE_URL: !Ref EmailNotificationQueueUrl
          WEBSOCKET_NOTIFICATION_QUEUE_URL: !Ref WebSocketNotificationQueueUrl
          FIREBASE_NOTIFICATION_QUEUE_URL: !Ref FirebaseNotificationQueueUrl
          EMAIL_SUPPRESSION_TABLE_NAME: !Ref EmailSuppressionTableName
      Tags:
        - Key: Environment
          Value: !Ref Environment

  ApiUpdateAppointment:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'api-update-appointment-${Environment}'
      Runtime: python3.13
      Handler: main.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Code:
        S3Bucket: !Ref CloudFormationBucket
        S3Key: lambda/api-update-appointment.zip
      Environment:
        Variables:
          STAFF_TABLE: !Ref StaffTable
          CONNECTIONS_TABLE: !Ref ConnectionsTable
          APPOINTMENTS_TABLE: !Ref AppointmentsTable
          SERVICE_PRICES_TABLE: !Ref ServicePricesTable
          USERS_TABLE: !Ref UsersTable
          ENVIRONMENT: !Ref Environment
          MAIL_FROM_ADDRESS: !Ref MailReceivingAddress
          FRONTEND_ROOT_URL: !Ref FrontendRootUrl
          EMAIL_NOTIFICATION_QUEUE_URL: !Ref EmailNotificationQueueUrl
          WEBSOCKET_NOTIFICATION_QUEUE_URL: !Ref WebSocketNotificationQueueUrl
          FIREBASE_NOTIFICATION_QUEUE_URL: !Ref FirebaseNotificationQueueUrl
          EMAIL_SUPPRESSION_TABLE_NAME: !Ref EmailSuppressionTableName
      Tags:
        - Key: Environment
          Value: !Ref Environment

  ApiGetUnavailableSlots:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'api-get-unavailable-slots-${Environment}'
      Runtime: python3.13
      Handler: main.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Code:
        S3Bucket: !Ref CloudFormationBucket
        S3Key: lambda/api-get-unavailable-slots.zip
      Environment:
        Variables:
          APPOINTMENTS_TABLE: !Ref AppointmentsTable
          UNAVAILABLE_SLOTS_TABLE: !Ref UnavailableSlotsTable
          ENVIRONMENT: !Ref Environment
      Tags:
        - Key: Environment
          Value: !Ref Environment

  ApiUpdateUnavailableSlots:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'api-update-unavailable-slots-${Environment}'
      Runtime: python3.13
      Handler: main.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Code:
        S3Bucket: !Ref CloudFormationBucket
        S3Key: lambda/api-update-unavailable-slots.zip
      Environment:
        Variables:
          STAFF_TABLE: !Ref StaffTable
          UNAVAILABLE_SLOTS_TABLE: !Ref UnavailableSlotsTable
          ENVIRONMENT: !Ref Environment
      Tags:
        - Key: Environment
          Value: !Ref Environment

  ApiGetOrders:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'api-get-orders-${Environment}'
      Runtime: python3.13
      Handler: main.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Code:
        S3Bucket: !Ref CloudFormationBucket
        S3Key: lambda/api-get-orders.zip
      Environment:
        Variables:
          STAFF_TABLE: !Ref StaffTable
          USERS_TABLE: !Ref UsersTable
          ORDERS_TABLE: !Ref OrdersTable
          ENVIRONMENT: !Ref Environment
      Tags:
        - Key: Environment
          Value: !Ref Environment

  ApiCreateOrder:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'api-create-order-${Environment}'
      Runtime: python3.13
      Handler: main.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Code:
        S3Bucket: !Ref CloudFormationBucket
        S3Key: lambda/api-create-order.zip
      Environment:
        Variables:
          STAFF_TABLE: !Ref StaffTable
          ORDERS_TABLE: !Ref OrdersTable
          USERS_TABLE: !Ref UsersTable
          CONNECTIONS_TABLE: !Ref ConnectionsTable
          ITEM_PRICES_TABLE: !Ref ItemPricesTable
          ENVIRONMENT: !Ref Environment
          MAIL_FROM_ADDRESS: !Ref MailReceivingAddress
          FRONTEND_ROOT_URL: !Ref FrontendRootUrl
          EMAIL_NOTIFICATION_QUEUE_URL: !Ref EmailNotificationQueueUrl
          WEBSOCKET_NOTIFICATION_QUEUE_URL: !Ref WebSocketNotificationQueueUrl
          FIREBASE_NOTIFICATION_QUEUE_URL: !Ref FirebaseNotificationQueueUrl
          EMAIL_SUPPRESSION_TABLE_NAME: !Ref EmailSuppressionTableName
      Tags:
        - Key: Environment
          Value: !Ref Environment

  ApiUpdateOrder:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'api-update-order-${Environment}'
      Runtime: python3.13
      Handler: main.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Code:
        S3Bucket: !Ref CloudFormationBucket
        S3Key: lambda/api-update-order.zip
      Environment:
        Variables:
          STAFF_TABLE: !Ref StaffTable
          CONNECTIONS_TABLE: !Ref ConnectionsTable
          ORDERS_TABLE: !Ref OrdersTable
          ITEM_PRICES_TABLE: !Ref ItemPricesTable
          USERS_TABLE: !Ref UsersTable
          ENVIRONMENT: !Ref Environment
          MAIL_FROM_ADDRESS: !Ref MailReceivingAddress
          FRONTEND_ROOT_URL: !Ref FrontendRootUrl
          EMAIL_NOTIFICATION_QUEUE_URL: !Ref EmailNotificationQueueUrl
          WEBSOCKET_NOTIFICATION_QUEUE_URL: !Ref WebSocketNotificationQueueUrl
          FIREBASE_NOTIFICATION_QUEUE_URL: !Ref FirebaseNotificationQueueUrl
          EMAIL_SUPPRESSION_TABLE_NAME: !Ref EmailSuppressionTableName
      Tags:
        - Key: Environment
          Value: !Ref Environment

  ApiConfirmCashPayment:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'api-confirm-cash-payment-${Environment}'
      Runtime: python3.13
      Handler: main.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Code:
        S3Bucket: !Ref CloudFormationBucket
        S3Key: lambda/api-confirm-cash-payment.zip
      Environment:
        Variables:
          STAFF_TABLE: !Ref StaffTable
          USERS_TABLE: !Ref UsersTable
          CONNECTIONS_TABLE: !Ref ConnectionsTable
          MESSAGES_TABLE: !Ref MessagesTable
          UNAVAILABLE_SLOTS_TABLE: !Ref UnavailableSlotsTable
          APPOINTMENTS_TABLE: !Ref AppointmentsTable
          SERVICE_PRICES_TABLE: !Ref ServicePricesTable
          ORDERS_TABLE: !Ref OrdersTable
          ITEM_PRICES_TABLE: !Ref ItemPricesTable
          PAYMENTS_TABLE: !Ref PaymentsTable
          INVOICES_TABLE: !Ref InvoicesTable
          STRIPE_SECRET_KEY: !Ref StripeSecretKey
          ENVIRONMENT: !Ref Environment
          REPORTS_BUCKET: !Ref ReportsBucketName
          CLOUDFRONT_DOMAIN: !Ref CloudFrontDomain
          FRONTEND_ROOT_URL: !Ref FrontendRootUrl
          INVOICE_QUEUE_URL: !Ref InvoiceQueueUrl
          MAIL_FROM_ADDRESS: !Ref MailReceivingAddress
          EMAIL_NOTIFICATION_QUEUE_URL: !Ref EmailNotificationQueueUrl
          WEBSOCKET_NOTIFICATION_QUEUE_URL: !Ref WebSocketNotificationQueueUrl
          FIREBASE_NOTIFICATION_QUEUE_URL: !Ref FirebaseNotificationQueueUrl
          EMAIL_SUPPRESSION_TABLE_NAME: !Ref EmailSuppressionTableName
      Tags:
        - Key: Environment
          Value: !Ref Environment

  ApiCreatePaymentIntent:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'api-create-payment-intent-${Environment}'
      Runtime: python3.13
      Handler: main.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Code:
        S3Bucket: !Ref CloudFormationBucket
        S3Key: lambda/api-create-payment-intent.zip
      Environment:
        Variables:
          USERS_TABLE: !Ref UsersTable
          APPOINTMENTS_TABLE: !Ref AppointmentsTable
          ORDERS_TABLE: !Ref OrdersTable
          PAYMENTS_TABLE: !Ref PaymentsTable
          STRIPE_SECRET_KEY: !Ref StripeSecretKey
          ENVIRONMENT: !Ref Environment
      Tags:
        - Key: Environment
          Value: !Ref Environment

  ApiConfirmStripePayment:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'api-confirm-stripe-payment-${Environment}'
      Runtime: python3.13
      Handler: main.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Code:
        S3Bucket: !Ref CloudFormationBucket
        S3Key: lambda/api-confirm-stripe-payment.zip
      Environment:
        Variables:
          STAFF_TABLE: !Ref StaffTable
          USERS_TABLE: !Ref UsersTable
          CONNECTIONS_TABLE: !Ref ConnectionsTable
          MESSAGES_TABLE: !Ref MessagesTable
          UNAVAILABLE_SLOTS_TABLE: !Ref UnavailableSlotsTable
          APPOINTMENTS_TABLE: !Ref AppointmentsTable
          SERVICE_PRICES_TABLE: !Ref ServicePricesTable
          ORDERS_TABLE: !Ref OrdersTable
          ITEM_PRICES_TABLE: !Ref ItemPricesTable
          PAYMENTS_TABLE: !Ref PaymentsTable
          INVOICES_TABLE: !Ref InvoicesTable
          STRIPE_SECRET_KEY: !Ref StripeSecretKey
          ENVIRONMENT: !Ref Environment
          REPORTS_BUCKET: !Ref ReportsBucketName
          CLOUDFRONT_DOMAIN: !Ref CloudFrontDomain
          FRONTEND_ROOT_URL: !Ref FrontendRootUrl
          INVOICE_QUEUE_URL: !Ref InvoiceQueueUrl
          MAIL_FROM_ADDRESS: !Ref MailReceivingAddress
          EMAIL_NOTIFICATION_QUEUE_URL: !Ref EmailNotificationQueueUrl
          WEBSOCKET_NOTIFICATION_QUEUE_URL: !Ref WebSocketNotificationQueueUrl
          FIREBASE_NOTIFICATION_QUEUE_URL: !Ref FirebaseNotificationQueueUrl
          EMAIL_SUPPRESSION_TABLE_NAME: !Ref EmailSuppressionTableName
      Tags:
        - Key: Environment
          Value: !Ref Environment

  ApiWebhookStripePayment:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'api-webhook-stripe-payment-${Environment}'
      Runtime: python3.13
      Handler: main.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Code:
        S3Bucket: !Ref CloudFormationBucket
        S3Key: lambda/api-webhook-stripe-payment.zip
      Environment:
        Variables:
          STAFF_TABLE: !Ref StaffTable
          USERS_TABLE: !Ref UsersTable
          CONNECTIONS_TABLE: !Ref ConnectionsTable
          MESSAGES_TABLE: !Ref MessagesTable
          UNAVAILABLE_SLOTS_TABLE: !Ref UnavailableSlotsTable
          APPOINTMENTS_TABLE: !Ref AppointmentsTable
          SERVICE_PRICES_TABLE: !Ref ServicePricesTable
          ORDERS_TABLE: !Ref OrdersTable
          ITEM_PRICES_TABLE: !Ref ItemPricesTable
          PAYMENTS_TABLE: !Ref PaymentsTable
          INVOICES_TABLE: !Ref InvoicesTable
          STRIPE_SECRET_KEY: !Ref StripeSecretKey
          STRIPE_WEBHOOK_SECRET: !Ref StripeWebhookSecret
          ENVIRONMENT: !Ref Environment
          REPORTS_BUCKET: !Ref ReportsBucketName
          CLOUDFRONT_DOMAIN: !Ref CloudFrontDomain
          FRONTEND_ROOT_URL: !Ref FrontendRootUrl
          INVOICE_QUEUE_URL: !Ref InvoiceQueueUrl
          MAIL_FROM_ADDRESS: !Ref MailReceivingAddress
          EMAIL_NOTIFICATION_QUEUE_URL: !Ref EmailNotificationQueueUrl
          WEBSOCKET_NOTIFICATION_QUEUE_URL: !Ref WebSocketNotificationQueueUrl
          FIREBASE_NOTIFICATION_QUEUE_URL: !Ref FirebaseNotificationQueueUrl
          EMAIL_SUPPRESSION_TABLE_NAME: !Ref EmailSuppressionTableName
      Tags:
        - Key: Environment
          Value: !Ref Environment

  ApiGetInquiries:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'api-get-inquiries-${Environment}'
      Runtime: python3.13
      Handler: main.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Code:
        S3Bucket: !Ref CloudFormationBucket
        S3Key: lambda/api-get-inquiries.zip
      Environment:
        Variables:
          STAFF_TABLE: !Ref StaffTable
          INQUIRIES_TABLE: !Ref InquiriesTable
          ENVIRONMENT: !Ref Environment
      Tags:
        - Key: Environment
          Value: !Ref Environment

  ApiCreateInquiry:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'api-create-inquiry-${Environment}'
      Runtime: python3.13
      Handler: main.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Code:
        S3Bucket: !Ref CloudFormationBucket
        S3Key: lambda/api-create-inquiry.zip
      Environment:
        Variables:
          CONNECTIONS_TABLE: !Ref ConnectionsTable
          INQUIRIES_TABLE: !Ref InquiriesTable
          USERS_TABLE: !Ref UsersTable
          ENVIRONMENT: !Ref Environment
          EMAIL_NOTIFICATION_QUEUE_URL: !Ref EmailNotificationQueueUrl
          WEBSOCKET_NOTIFICATION_QUEUE_URL: !Ref WebSocketNotificationQueueUrl
          FIREBASE_NOTIFICATION_QUEUE_URL: !Ref FirebaseNotificationQueueUrl
          EMAIL_SUPPRESSION_TABLE_NAME: !Ref EmailSuppressionTableName
      Tags:
        - Key: Environment
          Value: !Ref Environment

  ApiGetReportUploadUrl:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'api-get-report-upload-url-${Environment}'
      Runtime: python3.13
      Handler: main.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Code:
        S3Bucket: !Ref CloudFormationBucket
        S3Key: lambda/api-get-report-upload-url.zip
      Environment:
        Variables:
          APPOINTMENTS_TABLE: !Ref AppointmentsTable
          STAFF_TABLE: !Ref StaffTable
          CLOUDFRONT_DOMAIN: !Ref CloudFrontDomain
          REPORTS_BUCKET_NAME: !Ref ReportsBucketName
          ENVIRONMENT: !Ref Environment
      Tags:
        - Key: Environment
          Value: !Ref Environment

  ApiGetAnalytics:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'api-get-analytics-${Environment}'
      Runtime: python3.13
      Handler: main.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Code:
        S3Bucket: !Ref CloudFormationBucket
        S3Key: lambda/api-get-analytics.zip
      Environment:
        Variables:
          STAFF_TABLE: !Ref StaffTable
          APPOINTMENTS_TABLE: !Ref AppointmentsTable
          ORDERS_TABLE: !Ref OrdersTable
          ITEM_PRICES_TABLE: !Ref ItemPricesTable
          SERVICE_PRICES_TABLE: !Ref ServicePricesTable
          USERS_TABLE: !Ref UsersTable
          ENVIRONMENT: !Ref Environment
      Tags:
        - Key: Environment
          Value: !Ref Environment

  ApiGetStaffRoles:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'api-get-staff-roles-${Environment}'
      Runtime: python3.13
      Handler: main.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Code:
        S3Bucket: !Ref CloudFormationBucket
        S3Key: lambda/api-get-staff-roles.zip
      Environment:
        Variables:
          STAFF_TABLE: !Ref StaffTable
          SHARED_KEY: !Ref SharedKey
          ENVIRONMENT: !Ref Environment
      Tags:
        - Key: Environment
          Value: !Ref Environment

  ApiNotify:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'api-notify-${Environment}'
      Runtime: python3.13
      Handler: main.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Code:
        S3Bucket: !Ref CloudFormationBucket
        S3Key: lambda/api-notify.zip
      Environment:
        Variables:
          STAFF_TABLE: !Ref StaffTable
          USERS_TABLE: !Ref UsersTable
          CONNECTIONS_TABLE: !Ref ConnectionsTable
          MESSAGES_TABLE: !Ref MessagesTable
          ENVIRONMENT: !Ref Environment
          EMAIL_NOTIFICATION_QUEUE_URL: !Ref EmailNotificationQueueUrl
          WEBSOCKET_NOTIFICATION_QUEUE_URL: !Ref WebSocketNotificationQueueUrl
          FIREBASE_NOTIFICATION_QUEUE_URL: !Ref FirebaseNotificationQueueUrl
      Tags:
        - Key: Environment
          Value: !Ref Environment

  ApiTakeUser:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'api-take-user-${Environment}'
      Runtime: python3.13
      Handler: main.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Code:
        S3Bucket: !Ref CloudFormationBucket
        S3Key: lambda/api-take-user.zip
      Environment:
        Variables:
          STAFF_TABLE: !Ref StaffTable
          USERS_TABLE: !Ref UsersTable
          CONNECTIONS_TABLE: !Ref ConnectionsTable
          ENVIRONMENT: !Ref Environment
          EMAIL_NOTIFICATION_QUEUE_URL: !Ref EmailNotificationQueueUrl
          WEBSOCKET_NOTIFICATION_QUEUE_URL: !Ref WebSocketNotificationQueueUrl
          FIREBASE_NOTIFICATION_QUEUE_URL: !Ref FirebaseNotificationQueueUrl
      Tags:
        - Key: Environment
          Value: !Ref Environment

  ApiGetConnections:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'api-get-connections-${Environment}'
      Runtime: python3.13
      Handler: main.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Code:
        S3Bucket: !Ref CloudFormationBucket
        S3Key: lambda/api-get-connections.zip
      Environment:
        Variables:
          STAFF_TABLE: !Ref StaffTable
          CONNECTIONS_TABLE: !Ref ConnectionsTable
          ENVIRONMENT: !Ref Environment
      Tags:
        - Key: Environment
          Value: !Ref Environment

  ApiGetMessages:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'api-get-messages-${Environment}'
      Runtime: python3.13
      Handler: main.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Code:
        S3Bucket: !Ref CloudFormationBucket
        S3Key: lambda/api-get-messages.zip
      Environment:
        Variables:
          STAFF_TABLE: !Ref StaffTable
          MESSAGES_TABLE: !Ref MessagesTable
          USERS_TABLE: !Ref UsersTable
          ENVIRONMENT: !Ref Environment
      Tags:
        - Key: Environment
          Value: !Ref Environment

  ApiGetLastMessages:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'api-get-last-messages-${Environment}'
      Runtime: python3.13
      Handler: main.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Code:
        S3Bucket: !Ref CloudFormationBucket
        S3Key: lambda/api-get-last-messages.zip
      Environment:
        Variables:
          STAFF_TABLE: !Ref StaffTable
          MESSAGES_TABLE: !Ref MessagesTable
          ENVIRONMENT: !Ref Environment
      Tags:
        - Key: Environment
          Value: !Ref Environment

  ApiSendMessage:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'api-send-message-${Environment}'
      Runtime: python3.13
      Handler: main.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Code:
        S3Bucket: !Ref CloudFormationBucket
        S3Key: lambda/api-send-message.zip
      Environment:
        Variables:
          STAFF_TABLE: !Ref StaffTable
          USERS_TABLE: !Ref UsersTable
          MESSAGES_TABLE: !Ref MessagesTable
          CONNECTIONS_TABLE: !Ref ConnectionsTable
          ENVIRONMENT: !Ref Environment
          EMAIL_NOTIFICATION_QUEUE_URL: !Ref EmailNotificationQueueUrl
          WEBSOCKET_NOTIFICATION_QUEUE_URL: !Ref WebSocketNotificationQueueUrl
          FIREBASE_NOTIFICATION_QUEUE_URL: !Ref FirebaseNotificationQueueUrl
      Tags:
        - Key: Environment
          Value: !Ref Environment

  # WebSocket Lambda Functions
  WsConnect:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'ws-connect-${Environment}'
      Runtime: python3.13
      Handler: main.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Code:
        S3Bucket: !Ref CloudFormationBucket
        S3Key: lambda/ws-connect.zip
      Environment:
        Variables:
          CONNECTIONS_TABLE: !Ref ConnectionsTable
          ENVIRONMENT: !Ref Environment
      Tags:
        - Key: Environment
          Value: !Ref Environment

  WsDisconnect:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'ws-disconnect-${Environment}'
      Runtime: python3.13
      Handler: main.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Code:
        S3Bucket: !Ref CloudFormationBucket
        S3Key: lambda/ws-disconnect.zip
      Environment:
        Variables:
          CONNECTIONS_TABLE: !Ref ConnectionsTable
          USERS_TABLE: !Ref UsersTable
          ENVIRONMENT: !Ref Environment
      Tags:
        - Key: Environment
          Value: !Ref Environment

  WsInit:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'ws-init-${Environment}'
      Runtime: python3.13
      Handler: main.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Code:
        S3Bucket: !Ref CloudFormationBucket
        S3Key: lambda/ws-init.zip
      Environment:
        Variables:
          CONNECTIONS_TABLE: !Ref ConnectionsTable
          USERS_TABLE: !Ref UsersTable
          ENVIRONMENT: !Ref Environment
      Tags:
        - Key: Environment
          Value: !Ref Environment

  WsPing:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'ws-ping-${Environment}'
      Runtime: python3.13
      Handler: main.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Code:
        S3Bucket: !Ref CloudFormationBucket
        S3Key: lambda/ws-ping.zip
      Environment:
        Variables:
          ENVIRONMENT: !Ref Environment
      Tags:
        - Key: Environment
          Value: !Ref Environment

  WsStaffInit:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'ws-staff-init-${Environment}'
      Runtime: python3.13
      Handler: main.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Code:
        S3Bucket: !Ref CloudFormationBucket
        S3Key: lambda/ws-staff-init.zip
      Environment:
        Variables:
          AUTH0_DOMAIN: !Ref Auth0Domain
          AUTH0_AUDIENCE: !Ref Auth0Audience
          CONNECTIONS_TABLE: !Ref ConnectionsTable
          STAFF_TABLE: !Ref StaffTable
          ENVIRONMENT: !Ref Environment
      Tags:
        - Key: Environment
          Value: !Ref Environment

  ApiGetInvoices:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'api-get-invoices-${Environment}'
      Runtime: python3.13
      Handler: main.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Code:
        S3Bucket: !Ref CloudFormationBucket
        S3Key: lambda/api-get-invoices.zip
      Environment:
        Variables:
          STAFF_TABLE: !Ref StaffTable
          INVOICES_TABLE: !Ref InvoicesTable
          ENVIRONMENT: !Ref Environment
      Tags:
        - Key: Environment
          Value: !Ref Environment

  ApiGenerateInvoice:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'api-generate-invoice-${Environment}'
      Runtime: python3.13
      Handler: main.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Code:
        S3Bucket: !Ref CloudFormationBucket
        S3Key: lambda/api-generate-invoice.zip
      Environment:
        Variables:
          INVOICES_TABLE: !Ref InvoicesTable
          REPORTS_BUCKET: !Ref ReportsBucketName
          CLOUDFRONT_DOMAIN: !Ref CloudFrontDomain
          FRONTEND_ROOT_URL: !Ref FrontendRootUrl
          SHARED_KEY: !Ref SharedKey
          ENVIRONMENT: !Ref Environment
          MAIL_FROM_ADDRESS: !Ref MailReceivingAddress
      Tags:
        - Key: Environment
          Value: !Ref Environment

  # API Get Emails Function
  ApiGetEmails:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'api-get-emails-${Environment}'
      Runtime: python3.13
      Handler: main.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          ENVIRONMENT: !Ref Environment
          EMAIL_STORAGE_BUCKET: !Ref EmailStorageBucket
          EMAIL_METADATA_TABLE: !Ref EmailMetadataTable
          STAFF_TABLE: !Ref StaffTable
      Code:
        S3Bucket: !Ref CloudFormationBucket
        S3Key: 'lambda/api-get-emails.zip'
      Timeout: 30
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: AutoLabSolutions
        - Key: Purpose
          Value: EmailAPI

  # API Send Email Function
  ApiSendEmail:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'api-send-email-${Environment}'
      Runtime: python3.13
      Handler: main.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          ENVIRONMENT: !Ref Environment
          MAIL_FROM_ADDRESS: !Ref MailReceivingAddress
          NO_REPLY_EMAIL: !Ref MailSendingAddress
          EMAIL_STORAGE_BUCKET: !Ref EmailStorageBucket
          EMAIL_METADATA_TABLE: !Ref EmailMetadataTable
          EMAIL_SUPPRESSION_TABLE_NAME: !Ref EmailSuppressionTableName
          STAFF_TABLE: !Ref StaffTable
      Code:
        S3Bucket: !Ref CloudFormationBucket
        S3Key: 'lambda/api-send-email.zip'
      Timeout: 60
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: AutoLabSolutions
        - Key: Purpose
          Value: EmailAPI

Outputs:
  StaffAuthorizerArn:
    Description: Staff Authorizer Lambda ARN
    Value: !GetAtt StaffAuthorizer.Arn
    Export:
      Name: !Sub '${AWS::StackName}-StaffAuthorizerArn'

  StaffAuthorizerOptionalArn:
    Description: Staff Authorizer Optional Lambda ARN
    Value: !GetAtt StaffAuthorizerOptional.Arn
    Export:
      Name: !Sub '${AWS::StackName}-StaffAuthorizerOptionalArn'

  GetPricesArn:
    Description: Get Prices Lambda ARN
    Value: !GetAtt ApiGetPrices.Arn

  GetUsersArn:
    Description: Get Users Lambda ARN
    Value: !GetAtt ApiGetUsers.Arn

  GetAppointmentsArn:
    Description: Get Appointments Lambda ARN
    Value: !GetAtt ApiGetAppointments.Arn

  CreateAppointmentArn:
    Description: Create Appointment Lambda ARN
    Value: !GetAtt ApiCreateAppointment.Arn

  UpdateAppointmentArn:
    Description: Update Appointment Lambda ARN
    Value: !GetAtt ApiUpdateAppointment.Arn

  GetUnavailableSlotsArn:
    Description: Get Unavailable Slots Lambda ARN
    Value: !GetAtt ApiGetUnavailableSlots.Arn

  UpdateUnavailableSlotsArn:
    Description: Update Unavailable Slots Lambda ARN
    Value: !GetAtt ApiUpdateUnavailableSlots.Arn

  GetOrdersArn:
    Description: Get Orders Lambda ARN
    Value: !GetAtt ApiGetOrders.Arn

  CreateOrderArn:
    Description: Create Order Lambda ARN
    Value: !GetAtt ApiCreateOrder.Arn

  UpdateOrderArn:
    Description: Update Order Lambda ARN
    Value: !GetAtt ApiUpdateOrder.Arn

  ConfirmCashPaymentArn:
    Description: Confirm Cash Payment Lambda ARN
    Value: !GetAtt ApiConfirmCashPayment.Arn

  CreatePaymentIntentArn:
    Description: Create Payment Intent Lambda ARN
    Value: !GetAtt ApiCreatePaymentIntent.Arn

  ConfirmStripePaymentArn:
    Description: Confirm Stripe Payment Lambda ARN
    Value: !GetAtt ApiConfirmStripePayment.Arn

  WebhookStripePaymentArn:
    Description: Webhook Stripe Payment Lambda ARN
    Value: !GetAtt ApiWebhookStripePayment.Arn

  GetInquiriesArn:
    Description: Get Inquiries Lambda ARN
    Value: !GetAtt ApiGetInquiries.Arn

  CreateInquiryArn:
    Description: Create Inquiry Lambda ARN
    Value: !GetAtt ApiCreateInquiry.Arn

  GetReportUploadUrlArn:
    Description: Get Report Upload URL Lambda ARN
    Value: !GetAtt ApiGetReportUploadUrl.Arn

  GetAnalyticsArn:
    Description: Get Analytics Lambda ARN
    Value: !GetAtt ApiGetAnalytics.Arn

  GetStaffRolesArn:
    Description: Get Staff Roles Lambda ARN
    Value: !GetAtt ApiGetStaffRoles.Arn

  NotifyArn:
    Description: Notify Lambda ARN
    Value: !GetAtt ApiNotify.Arn

  TakeUserArn:
    Description: Take User Lambda ARN
    Value: !GetAtt ApiTakeUser.Arn

  GetConnectionsArn:
    Description: Get Connections Lambda ARN
    Value: !GetAtt ApiGetConnections.Arn

  GetMessagesArn:
    Description: Get Messages Lambda ARN
    Value: !GetAtt ApiGetMessages.Arn

  GetLastMessagesArn:
    Description: Get Last Messages Lambda ARN
    Value: !GetAtt ApiGetLastMessages.Arn

  SendMessageArn:
    Description: Send Message Lambda ARN
    Value: !GetAtt ApiSendMessage.Arn

  WsConnectArn:
    Description: WebSocket Connect Lambda ARN
    Value: !GetAtt WsConnect.Arn

  WsDisconnectArn:
    Description: WebSocket Disconnect Lambda ARN
    Value: !GetAtt WsDisconnect.Arn

  WsInitArn:
    Description: WebSocket Init Lambda ARN
    Value: !GetAtt WsInit.Arn

  WsPingArn:
    Description: WebSocket Ping Lambda ARN
    Value: !GetAtt WsPing.Arn

  WsStaffInitArn:
    Description: WebSocket Staff Init Lambda ARN
    Value: !GetAtt WsStaffInit.Arn

  GetInvoicesArn:
    Description: Get Invoices Lambda ARN
    Value: !GetAtt ApiGetInvoices.Arn

  ApiGenerateInvoiceArn:
    Description: Generate Invoice Lambda ARN
    Value: !GetAtt ApiGenerateInvoice.Arn

  ApiGetEmailsArn:
    Description: Get Emails API Lambda ARN
    Value: !GetAtt ApiGetEmails.Arn
    Export:
      Name: !Sub '${AWS::StackName}-ApiGetEmailsArn'

  ApiSendEmailArn:
    Description: Send Email API Lambda ARN
    Value: !GetAtt ApiSendEmail.Arn
    Export:
      Name: !Sub '${AWS::StackName}-ApiSendEmailArn'

