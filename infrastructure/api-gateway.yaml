AWSTemplateFormatVersion: '2010-09-09'
Description: 'REST API Gateway for Auto Lab Solutions'

Parameters:
  Environment:
    Type: String
    Default: production
    Description: Environment name
  
  StaffAuthorizerArn:
    Type: String
    Description: Staff Authorizer Lambda ARN
  
  StaffAuthorizerOptionalArn:
    Type: String
    Description: Staff Authorizer Optional Lambda ARN
  
  GetPricesArn:
    Type: String
    Description: Get Prices Lambda ARN
  
  GetUsersArn:
    Type: String
    Description: Get Users Lambda ARN
  
  GetAppointmentsArn:
    Type: String
    Description: Get Appointments Lambda ARN
  
  CreateAppointmentArn:
    Type: String
    Description: Create Appointment Lambda ARN
  
  UpdateAppointmentArn:
    Type: String
    Description: Update Appointment Lambda ARN
  
  GetUnavailableSlotsArn:
    Type: String
    Description: Get Unavailable Slots Lambda ARN
  
  UpdateUnavailableSlotsArn:
    Type: String
    Description: Update Unavailable Slots Lambda ARN
  
  GetOrdersArn:
    Type: String
    Description: Get Orders Lambda ARN
  
  CreateOrderArn:
    Type: String
    Description: Create Order Lambda ARN
  
  UpdateOrderArn:
    Type: String
    Description: Update Order Lambda ARN
  
  ConfirmPaymentArn:
    Type: String
    Description: Confirm Payment Lambda ARN
  
  CreatePaymentIntentArn:
    Type: String
    Description: Create Payment Intent Lambda ARN
  
  ConfirmPaymentSuccessArn:
    Type: String
    Description: Confirm Payment Success Lambda ARN
  
  WebhookStripePaymentArn:
    Type: String
    Description: Webhook Stripe Payment Lambda ARN
  
  GetInquiriesArn:
    Type: String
    Description: Get Inquiries Lambda ARN
  
  CreateInquiryArn:
    Type: String
    Description: Create Inquiry Lambda ARN
  
  GetReportUploadUrlArn:
    Type: String
    Description: Get Report Upload URL Lambda ARN
  
  GetAnalyticsArn:
    Type: String
    Description: Get Analytics Lambda ARN
  
  GetStaffRolesArn:
    Type: String
    Description: Get Staff Roles Lambda ARN
  
  NotifyArn:
    Type: String
    Description: Notify Lambda ARN
  
  TakeUserArn:
    Type: String
    Description: Take User Lambda ARN
  
  GetConnectionsArn:
    Type: String
    Description: Get Connections Lambda ARN
  
  GetMessagesArn:
    Type: String
    Description: Get Messages Lambda ARN
  
  GetLastMessagesArn:
    Type: String
    Description: Get Last Messages Lambda ARN
  
  SendMessageArn:
    Type: String
    Description: Send Message Lambda ARN

Resources:
  # REST API
  RestApi:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: auto-lab-rest-api
      Description: Auto Lab Solutions REST API
      EndpointConfiguration:
        Types:
          - REGIONAL
      Policy:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal: '*'
            Action: execute-api:Invoke
            Resource: '*'

  # Authorizers
  StaffAuthorizer:
    Type: AWS::ApiGateway::Authorizer
    Properties:
      Name: staff-authorizer
      Type: REQUEST
      RestApiId: !Ref RestApi
      AuthorizerUri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${StaffAuthorizerArn}/invocations'
      AuthorizerCredentials: !GetAtt ApiGatewayExecutionRole.Arn
      IdentitySource: method.request.header.Authorization

  StaffAuthorizerOptional:
    Type: AWS::ApiGateway::Authorizer
    Properties:
      Name: staff-authorizer-optional
      Type: REQUEST
      RestApiId: !Ref RestApi
      AuthorizerUri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${StaffAuthorizerOptionalArn}/invocations'
      AuthorizerCredentials: !GetAtt ApiGatewayExecutionRole.Arn
      IdentitySource: method.request.header.Authorization

  # API Gateway Execution Role
  ApiGatewayExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: apigateway.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: LambdaInvokePolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - lambda:InvokeFunction
                Resource: '*'

  # Resources and Methods
  PricesResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref RestApi
      ParentId: !GetAtt RestApi.RootResourceId
      PathPart: prices

  PricesMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref RestApi
      ResourceId: !Ref PricesResource
      HttpMethod: GET
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref StaffAuthorizer
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${GetPricesArn}/invocations'

  UsersResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref RestApi
      ParentId: !GetAtt RestApi.RootResourceId
      PathPart: users

  UsersMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref RestApi
      ResourceId: !Ref UsersResource
      HttpMethod: GET
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref StaffAuthorizer
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${GetUsersArn}/invocations'

  AppointmentsResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref RestApi
      ParentId: !GetAtt RestApi.RootResourceId
      PathPart: appointments

  AppointmentsGetMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref RestApi
      ResourceId: !Ref AppointmentsResource
      HttpMethod: GET
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref StaffAuthorizer
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${GetAppointmentsArn}/invocations'

  AppointmentsPostMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref RestApi
      ResourceId: !Ref AppointmentsResource
      HttpMethod: POST
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref StaffAuthorizer
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${CreateAppointmentArn}/invocations'

  AppointmentsPutMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref RestApi
      ResourceId: !Ref AppointmentsResource
      HttpMethod: PUT
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref StaffAuthorizer
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${UpdateAppointmentArn}/invocations'

  UnavailableSlotsResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref RestApi
      ParentId: !GetAtt RestApi.RootResourceId
      PathPart: unavailable-slots

  UnavailableSlotsGetMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref RestApi
      ResourceId: !Ref UnavailableSlotsResource
      HttpMethod: GET
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref StaffAuthorizerOptional
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${GetUnavailableSlotsArn}/invocations'

  UnavailableSlotsPutMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref RestApi
      ResourceId: !Ref UnavailableSlotsResource
      HttpMethod: PUT
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref StaffAuthorizer
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${UpdateUnavailableSlotsArn}/invocations'

  OrdersResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref RestApi
      ParentId: !GetAtt RestApi.RootResourceId
      PathPart: orders

  OrdersGetMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref RestApi
      ResourceId: !Ref OrdersResource
      HttpMethod: GET
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref StaffAuthorizer
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${GetOrdersArn}/invocations'

  OrdersPostMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref RestApi
      ResourceId: !Ref OrdersResource
      HttpMethod: POST
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref StaffAuthorizer
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${CreateOrderArn}/invocations'

  OrdersPutMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref RestApi
      ResourceId: !Ref OrdersResource
      HttpMethod: PUT
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref StaffAuthorizer
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${UpdateOrderArn}/invocations'

  ConfirmPaymentResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref RestApi
      ParentId: !GetAtt RestApi.RootResourceId
      PathPart: confirm-payment

  ConfirmPaymentMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref RestApi
      ResourceId: !Ref ConfirmPaymentResource
      HttpMethod: POST
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref StaffAuthorizer
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ConfirmPaymentArn}/invocations'

  InquiriesResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref RestApi
      ParentId: !GetAtt RestApi.RootResourceId
      PathPart: inquiries

  InquiriesGetMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref RestApi
      ResourceId: !Ref InquiriesResource
      HttpMethod: GET
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref StaffAuthorizer
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${GetInquiriesArn}/invocations'

  InquiriesPostMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref RestApi
      ResourceId: !Ref InquiriesResource
      HttpMethod: POST
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref StaffAuthorizerOptional
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${CreateInquiryArn}/invocations'

  ReportUploadUrlResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref RestApi
      ParentId: !GetAtt RestApi.RootResourceId
      PathPart: get-report-upload-url

  ReportUploadUrlMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref RestApi
      ResourceId: !Ref ReportUploadUrlResource
      HttpMethod: GET
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref StaffAuthorizer
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${GetReportUploadUrlArn}/invocations'

  AnalyticsResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref RestApi
      ParentId: !GetAtt RestApi.RootResourceId
      PathPart: analytics

  AnalyticsMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref RestApi
      ResourceId: !Ref AnalyticsResource
      HttpMethod: GET
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref StaffAuthorizer
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${GetAnalyticsArn}/invocations'

  GetStaffRolesResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref RestApi
      ParentId: !GetAtt RestApi.RootResourceId
      PathPart: get-staff-roles

  GetStaffRolesMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref RestApi
      ResourceId: !Ref GetStaffRolesResource
      HttpMethod: GET
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${GetStaffRolesArn}/invocations'

  NotifyResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref RestApi
      ParentId: !GetAtt RestApi.RootResourceId
      PathPart: notify

  NotifyMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref RestApi
      ResourceId: !Ref NotifyResource
      HttpMethod: POST
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref StaffAuthorizer
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${NotifyArn}/invocations'

  TakeUserResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref RestApi
      ParentId: !GetAtt RestApi.RootResourceId
      PathPart: take-user

  TakeUserMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref RestApi
      ResourceId: !Ref TakeUserResource
      HttpMethod: POST
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref StaffAuthorizer
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${TakeUserArn}/invocations'

  ConnectionsResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref RestApi
      ParentId: !GetAtt RestApi.RootResourceId
      PathPart: connections

  ConnectionsMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref RestApi
      ResourceId: !Ref ConnectionsResource
      HttpMethod: GET
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref StaffAuthorizer
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${GetConnectionsArn}/invocations'

  MessagesResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref RestApi
      ParentId: !GetAtt RestApi.RootResourceId
      PathPart: messages

  MessagesGetMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref RestApi
      ResourceId: !Ref MessagesResource
      HttpMethod: GET
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref StaffAuthorizer
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${GetMessagesArn}/invocations'

  MessagesPostMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref RestApi
      ResourceId: !Ref MessagesResource
      HttpMethod: POST
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref StaffAuthorizer
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${SendMessageArn}/invocations'

  LastMessagesResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref RestApi
      ParentId: !GetAtt RestApi.RootResourceId
      PathPart: last-messages

  LastMessagesMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref RestApi
      ResourceId: !Ref LastMessagesResource
      HttpMethod: GET
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref StaffAuthorizer
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${GetLastMessagesArn}/invocations'

  # Payment Endpoints
  PaymentsResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref RestApi
      ParentId: !GetAtt RestApi.RootResourceId
      PathPart: payments

  CreatePaymentIntentResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref RestApi
      ParentId: !Ref PaymentsResource
      PathPart: create-intent

  CreatePaymentIntentMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref RestApi
      ResourceId: !Ref CreatePaymentIntentResource
      HttpMethod: POST
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref StaffAuthorizerOptional
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${CreatePaymentIntentArn}/invocations'

  ConfirmPaymentV2Resource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref RestApi
      ParentId: !Ref PaymentsResource
      PathPart: confirm

  ConfirmPaymentV2Method:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref RestApi
      ResourceId: !Ref ConfirmPaymentV2Resource
      HttpMethod: POST
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref StaffAuthorizerOptional
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ConfirmPaymentArn}/invocations'

  ConfirmPaymentSuccessResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref RestApi
      ParentId: !Ref PaymentsResource
      PathPart: confirm-success

  ConfirmPaymentSuccessMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref RestApi
      ResourceId: !Ref ConfirmPaymentSuccessResource
      HttpMethod: POST
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref StaffAuthorizerOptional
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ConfirmPaymentSuccessArn}/invocations'

  # Webhook Endpoints
  WebhooksResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref RestApi
      ParentId: !GetAtt RestApi.RootResourceId
      PathPart: webhooks

  StripePaymentWebhookResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref RestApi
      ParentId: !Ref WebhooksResource
      PathPart: stripe-payment

  StripePaymentWebhookMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref RestApi
      ResourceId: !Ref StripePaymentWebhookResource
      HttpMethod: POST
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WebhookStripePaymentArn}/invocations'

  # Lambda Permissions
  GetPricesPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref GetPricesArn
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${RestApi}/*/*'

  GetUsersPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref GetUsersArn
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${RestApi}/*/*'

  GetAppointmentsPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref GetAppointmentsArn
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${RestApi}/*/*'

  CreateAppointmentPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref CreateAppointmentArn
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${RestApi}/*/*'

  UpdateAppointmentPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref UpdateAppointmentArn
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${RestApi}/*/*'

  GetUnavailableSlotsPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref GetUnavailableSlotsArn
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${RestApi}/*/*'

  UpdateUnavailableSlotsPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref UpdateUnavailableSlotsArn
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${RestApi}/*/*'

  GetOrdersPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref GetOrdersArn
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${RestApi}/*/*'

  CreateOrderPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref CreateOrderArn
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${RestApi}/*/*'

  UpdateOrderPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref UpdateOrderArn
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${RestApi}/*/*'

  ConfirmPaymentPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref ConfirmPaymentArn
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${RestApi}/*/*'

  CreatePaymentIntentPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref CreatePaymentIntentArn
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${RestApi}/*/*'

  ConfirmPaymentSuccessPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref ConfirmPaymentSuccessArn
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${RestApi}/*/*'

  WebhookStripePaymentPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref WebhookStripePaymentArn
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${RestApi}/*/*'

  GetInquiriesPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref GetInquiriesArn
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${RestApi}/*/*'

  CreateInquiryPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref CreateInquiryArn
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${RestApi}/*/*'

  GetReportUploadUrlPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref GetReportUploadUrlArn
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${RestApi}/*/*'

  GetAnalyticsPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref GetAnalyticsArn
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${RestApi}/*/*'

  GetStaffRolesPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref GetStaffRolesArn
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${RestApi}/*/*'

  NotifyPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref NotifyArn
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${RestApi}/*/*'

  TakeUserPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref TakeUserArn
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${RestApi}/*/*'

  GetConnectionsPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref GetConnectionsArn
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${RestApi}/*/*'

  GetMessagesPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref GetMessagesArn
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${RestApi}/*/*'

  GetLastMessagesPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref GetLastMessagesArn
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${RestApi}/*/*'

  SendMessagePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref SendMessageArn
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${RestApi}/*/*'

  StaffAuthorizerPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref StaffAuthorizerArn
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${RestApi}/authorizers/${StaffAuthorizer}'

  StaffAuthorizerOptionalPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref StaffAuthorizerOptionalArn
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${RestApi}/authorizers/${StaffAuthorizerOptional}'

  # API Gateway Stage
  ApiStage:
    Type: AWS::ApiGateway::Stage
    Properties:
      RestApiId: !Ref RestApi
      DeploymentId: !Ref ApiDeployment
      StageName: !Ref Environment
      Description: !Sub 'API Gateway stage for ${Environment}'
      Variables:
        environment: !Ref Environment

  # Deployment
  ApiDeployment:
    Type: AWS::ApiGateway::Deployment
    DependsOn:
      - PricesMethod
      - UsersMethod
      - AppointmentsGetMethod
      - AppointmentsPostMethod
      - AppointmentsPutMethod
      - UnavailableSlotsGetMethod
      - UnavailableSlotsPutMethod
      - OrdersGetMethod
      - OrdersPostMethod
      - OrdersPutMethod
      - ConfirmPaymentMethod
      - InquiriesGetMethod
      - InquiriesPostMethod
      - ReportUploadUrlMethod
      - AnalyticsMethod
      - GetStaffRolesMethod
      - NotifyMethod
      - TakeUserMethod
      - ConnectionsMethod
      - MessagesGetMethod
      - MessagesPostMethod
      - LastMessagesMethod
      - CreatePaymentIntentMethod
      - ConfirmPaymentV2Method
      - ConfirmPaymentSuccessMethod
    Properties:
      RestApiId: !Ref RestApi

Outputs:
  RestApiId:
    Description: REST API ID
    Value: !Ref RestApi
    Export:
      Name: !Sub '${AWS::StackName}-RestApiId'

  RestApiEndpoint:
    Description: REST API Endpoint
    Value: !Sub 'https://${RestApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}'
    Export:
      Name: !Sub '${AWS::StackName}-RestApiEndpoint'

  ApiStageArn:
    Description: API Gateway Stage ARN
    Value: !Sub 'arn:aws:apigateway:${AWS::Region}::/restapis/${RestApi}/stages/${Environment}'
    Export:
      Name: !Sub '${AWS::StackName}-ApiStageArn'
